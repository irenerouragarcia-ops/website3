<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FND Knowledge Cluster</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;600;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #ffffff;
            /* White background */
            font-family: 'Comfortaa', cursive;
            color: #333;
            /* Dark text */
        }

        #container {
            position: absolute;
            /* Explicit positioning */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 1;
        }

        /* 3D Label Styling */
        .element {
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.4s ease;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
            backface-visibility: hidden;
            pointer-events: auto;
        }

        .title-node {
            font-weight: 700;
            text-transform: capitalize;
            letter-spacing: 1px;
            padding: 10px;
            z-index: 10;
        }

        .sub-node {
            font-weight: 500;
            opacity: 0.85;
            /* Better visibility on light */
            padding: 2px 6px;
            border-radius: 4px;
        }

        .sub-node:hover {
            opacity: 1;
            color: #fff !important;
            /* White text on hover */
            transform: scale(1.3);
            background: rgba(0, 0, 0, 0.6);
            /* Dark background on hover */
            backdrop-filter: blur(2px);
            z-index: 1000;
        }

        .title-node:hover {
            transform: scale(1.1);
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            z-index: 100;
            /* Fix: Ensure UI sits above 3D scene */
        }

        /* Top Bar */
        #top-bar {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            position: relative;
        }

        /* Removed #main-title as per request */

        /* Bottom Right Controls */
        #controls-container {
            pointer-events: auto;
            align-self: center;
            /* Center on mobile */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.7);
            /* Light Glass */
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 768px) {
            #controls-container {
                align-self: flex-end;
                margin-bottom: 50px;
            }
        }

        .btn {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #555;
            padding: 6px 14px;
            cursor: pointer;
            border-radius: 20px;
            font-family: 'Comfortaa', cursive;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn:hover {
            color: #000;
            border-color: #000;
        }

        .btn.active {
            background: rgba(0, 0, 0, 0.1);
            color: #000;
            border-color: rgba(0, 0, 0, 0.5);
        }

        .icon-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: serif;
            /* Keep simple icon style */
            font-style: italic;
            font-size: 14px;
        }

        #info-btn {
            background-color: #2E7D32;
            /* Deep Green */
            color: white;
            border-color: #1B5E20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #info-btn:hover {
            background-color: #1B5E20;
            border-color: #1B5E20;
        }

        /* Language Select */
        #lang-select {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #333;
            padding: 6px 10px;
            border-radius: 20px;
            font-family: 'Comfortaa', cursive;
            font-size: 11px;
            cursor: pointer;
            outline: none;
            text-transform: uppercase;
        }

        #lang-select option {
            background: #fff;
            color: #000;
        }

        /* Tooltip / Modal Styling */
        #tooltip-overlay,
        #info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            /* Light overlay dim */
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-card {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.05);
            /* Light border */
            width: 85%;
            max-width: 500px;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            /* Soft shadow */
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease-out;
            text-align: center;
            pointer-events: auto;
            position: relative;
            color: #333;
        }

        .modal-card.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-title {
            font-family: 'Comfortaa', cursive;
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: #000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 15px;
        }

        .modal-content {
            font-family: 'Comfortaa', cursive;
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .info-list {
            text-align: left;
            margin: 0 auto;
            max-width: 300px;
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 10px;
        }

        .modal-link {
            display: inline-block;
            background: #333;
            border: 1px solid #333;
            color: white;
            text-decoration: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .modal-link:hover {
            background: #555;
            border-color: #555;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: #000;
        }

        #viz-logo {
            position: absolute;
            bottom: 15px;
            right: 20px;
            width: 80px;
            /* Twice as big */
            height: auto;
            opacity: 0.3;
            /* Hidden/Ghosted by default */
            z-index: 200;
            cursor: pointer;
            transition: opacity 0.3s;
            mix-blend-mode: multiply;
        }

        #viz-logo:hover,
        #viz-logo.active {
            opacity: 1;
        }

        /* Logo Contact Card */
        #logo-card {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 300;
            border: 1px solid rgba(0, 0, 0, 0.05);
            width: 200px;
        }

        #logo-card.visible {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        #logo-card img {
            width: 150px;
            /* Larger version */
            height: auto;
            margin-bottom: 15px;
            mix-blend-mode: multiply;
        }

        .email-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #333;
            text-decoration: none;
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .email-row:hover {
            background: #e0e0e0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <!-- UI Controls -->
    <div id="ui-layer">
        <div id="top-bar">
            <!-- Title Removed -->
        </div>

        <div id="controls-container">
            <!-- Language Selector -->
            <select id="lang-select">
                <option value="en">English</option>
                <option value="es">Español</option>
            </select>

            <button id="toggle-anim" class="btn active">Auto-Pilot</button>
            <button id="reset-cam" class="btn">Reset</button>
            <button id="info-btn" class="btn icon-btn" title="Help / Ayuda">?</button>
        </div>

        <!-- Logo and Card -->
        <img id="viz-logo" src="assets/og_logo.jpg" alt="Ontology Graphics">

        <div id="logo-card">
            <img src="assets/og_logo.jpg" alt="Ontology Graphics Large">
            <a href="mailto:john@thisequals.net" class="email-row">
                <span>✉️</span>
                <span>john@thisequals.net</span>
            </a>
        </div>
    </div>

    <!-- 3D Container -->
    <div id="container"></div>

    <!-- Content Popup Modal -->
    <div id="tooltip-overlay">
        <div id="tooltip-card" class="modal-card">
            <button id="close-tooltip" class="close-modal">&times;</button>
            <h2 id="tooltip-title" class="modal-title">Title</h2>
            <p id="tooltip-def" class="modal-content">Definition goes here.</p>
            <a id="tooltip-link" class="modal-link" href="#" target="_blank">Read on Wikipedia</a>
        </div>
    </div>

    <!-- Info/Help Modal -->
    <div id="info-overlay">
        <div id="info-card" class="modal-card">
            <button id="close-info" class="close-modal">&times;</button>
            <h2 class="modal-title" id="info-head">Guide</h2>
            <div class="modal-content">
                <ul class="info-list" id="info-list">
                    <li><strong>Click</strong> words to see definitions.</li>
                    <li><strong>Drag</strong> to rotate the view.</li>
                    <li><strong>Scroll</strong> to zoom in/out.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Three.js Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- Main Logic -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

        // --- UI TEXT DICTIONARY ---
        const uiText = {
            en: {
                autoPilot: "Auto-Pilot",
                resume: "Resume",
                reset: "Reset",
                guide: "Guide",
                wiki: "Read on Wikipedia",
                infoList: `<li><strong>Click</strong> words to see definitions.</li>
                           <li><strong>Drag</strong> to rotate the view.</li>
                           <li><strong>Scroll</strong> to zoom in/out.</li>`
            },
            es: {
                autoPilot: "Piloto Auto",
                resume: "Reanudar",
                reset: "Reiniciar",
                guide: "Guía",
                wiki: "Leer en Wikipedia",
                infoList: `<li><strong>Clic</strong> para ver definiciones.</li>
                           <li><strong>Arrastra</strong> para rotar la vista.</li>
                           <li><strong>Desplaza</strong> para hacer zoom.</li>`
            }
        };

        // --- MULTILINGUAL DATA ---
        // Colors updated for visibility on White Background
        const fndData = {
            en: {
                title: "Functional Neurological Disorder",
                clusters: {
                    symptoms: {
                        label: "Symptoms",
                        color: '#D32F2F', center: { x: -350, y: 150, z: -100 },
                        def: "Common physical manifestations.",
                        words: [
                            { t: "Limb Weakness", d: "Sudden weakness or paralysis in a leg or arm, often dragging the leg while walking.", w: "Paresis" },
                            { t: "Tremor", d: "Involuntary shaking, often variable in rhythm or distracted by other movements.", w: "Tremor" },
                            { t: "NEAD", d: "Non-Epileptic Attack Disorder (or Dissociative Seizures).", w: "Non-epileptic_seizure" },
                            { t: "Functional Gait", d: "Abnormal walking patterns, such as dragging a leg or excessive slowness.", w: "Gait_abnormality" },
                            { t: "Dystonia", d: "Involuntary muscle contractions causing repetitive or twisting movements.", w: "Dystonia" },
                            { t: "Sensory Loss", d: "Numbness, tingling, or loss of sensation, often stopping abruptly.", w: "Paresthesia" },
                            { t: "Speech Issues", d: "Functional dysphonia (whispering), stuttering, or slurred speech.", w: "Dysphonia" },
                            { t: "Brain Fog", d: "Cognitive difficulties involving memory, concentration, and feeling 'spaced out'.", w: "Clouding_of_consciousness" },
                            { t: "Fatigue", d: "Extreme tiredness that is not relieved by rest.", w: "Fatigue_(medical)" },
                            { t: "Visual Disturbance", d: "Blurred vision, tunnel vision, or temporary blindness.", w: "Visual_disturbance" },
                            { t: "Drop Attacks", d: "Sudden falls without loss of consciousness.", w: "Drop_attack" },
                            { t: "Chronic Pain", d: "Persistent pain that often co-occurs with functional symptoms.", w: "Chronic_pain" },
                            { t: "Somatization", d: "Production of recurrent medical symptoms with no organic cause.", w: "Somatization" },
                            { t: "Functional Tics", d: "Sudden, rapid, recurrent, nonrhythmic motor movements or vocalizations.", w: "Tic" }
                        ]
                    },
                    mechanisms: {
                        label: "Mechanisms",
                        color: '#512DA8', center: { x: 350, y: 150, z: -100 },
                        def: "Theories explaining why FND happens.",
                        words: [
                            { t: "Software Issue", d: "Hardware intact, software crashing.", w: "Functional_neurological_symptom_disorder" },
                            { t: "Predictive Coding", d: "Brain predicts symptoms based on expectation.", w: "Predictive_coding" },
                            { t: "Attention", d: "Abnormal focus on body; movement improves when distracted.", w: "Attention" },
                            { t: "Agency", d: "Disrupted sense of ownership of movement.", w: "Sense_of_agency" },
                            { t: "Limbic System", d: "Emotional center hijacking motor control.", w: "Limbic_system" },
                            { t: "Disconnect", d: "Functional disconnection between planning and execution areas.", w: "Functional_connectivity" },
                            { t: "Central Sensitization", d: "Nervous system stuck in high reactivity.", w: "Central_sensitization" },
                            { t: "Biopsychosocial", d: "Biological, psychological, and social factors combined.", w: "Biopsychosocial_model" },
                            { t: "Psychogenic", d: "Older term suggesting symptoms are 'all in the mind'.", w: "Psychogenic_disease" },
                            { t: "Conversion", d: "Freudian concept of physical symptoms resolving emotional conflict.", w: "Conversion_disorder" },
                            { t: "Trigger", d: "Physical injury or illness precipitating onset.", w: "Trauma_trigger" },
                            { t: "Bayesian Brain", d: "Theory that the brain generates models of the world and updates them based on sensory input.", w: "Bayesian_approaches_to_brain_function" },
                            { t: "Nocebo", d: "Negative expectations leading to negative outcomes.", w: "Nocebo" }
                        ]
                    },
                    diagnosis: {
                        label: "Diagnosis",
                        color: '#1565C0', center: { x: -200, y: -250, z: 200 },
                        def: "How FND is identified.",
                        words: [
                            { t: "Hoover's Sign", d: "Hip extension weakness improves with contralateral resistance.", w: "Hoover's_sign_(leg_paresis)" },
                            { t: "Entrainment", d: "Tremor takes on rhythm of external tapping.", w: "Tremor" },
                            { t: "Distractibility", d: "Symptoms improve with distraction.", w: "Distraction" },
                            { t: "Positive Signs", d: "Specific clinical features unique to FND.", w: "Functional_neurological_symptom_disorder" },
                            { t: "Rule-In", d: "Diagnosis based on signs, not just exclusion.", w: "Functional_neurological_symptom_disorder" },
                            { t: "Normal MRI", d: "Scans show intact structure (hardware).", w: "Magnetic_resonance_imaging" },
                            { t: "Video EEG", d: "Distinguishes dissociative seizures from epilepsy.", w: "Video-EEG_monitoring" },
                            { t: "Neurologist", d: "Specialist in nervous system disorders.", w: "Neurologist" },
                            { t: "Inconsistency", d: "Variation in symptom severity by context.", w: "Functional_neurological_symptom_disorder" },
                            { t: "Incongruence", d: "Symptoms not aligning with anatomical pathways.", w: "Functional_neurological_symptom_disorder" },
                            { t: "Sign of the Grimace", d: "Facial grimacing during effortful movement.", w: "Functional_neurological_symptom_disorder" },
                            { t: "Drift without Pronation", d: "Arm drifts down without turning inward (unlike stroke).", w: "Pronator_drift" }
                        ]
                    },
                    treatment: {
                        label: "Treatment",
                        color: '#2E7D32', center: { x: 300, y: -250, z: 200 },
                        def: "Therapies for recovery.",
                        words: [
                            { t: "Neuroplasticity", d: "Brain's ability to rewire itself.", w: "Neuroplasticity" },
                            { t: "Physiotherapy", d: "Retraining normal movement patterns.", w: "Physical_therapy" },
                            { t: "CBT", d: "Cognitive Behavioral Therapy for symptom management.", w: "Cognitive_behavioral_therapy" },
                            { t: "Retraining", d: "Accessing normal motor programs again.", w: "Rehabilitation" },
                            { t: "Occupational Therapy", d: "Regaining independence in daily life.", w: "Occupational_therapy" },
                            { t: "Multidisciplinary", d: "Team approach (Neuro, Physio, Psych).", w: "Interdisciplinary_team" },
                            { t: "Pacing", d: "Managing activity to avoid boom-bust cycles.", w: "Pacing_(activity_management)" },
                            { t: "Education", d: "Understanding the diagnosis is therapeutic.", w: "Psychoeducation" },
                            { t: "Distraction", d: "Bypassing conscious monitoring to facilitate movement.", w: "Distraction" },
                            { t: "Acceptance", d: "Focusing on recovery rather than searching for causes.", w: "Acceptance_and_commitment_therapy" },
                            { t: "Graded Exercise", d: "Slowly increasing activity tolerance.", w: "Graded_exercise_therapy" },
                            { t: "Validation", d: "Acknowledging symptoms are real.", w: "Validation_(psychology)" },
                            { t: "Hypnotherapy", d: "Using trance states to alter symptom perception.", w: "Hypnotherapy" },
                            { t: "Mirror Therapy", d: "Using visual feedback to trick the brain into normal movement.", w: "Mirror_therapy" }
                        ]
                    }
                }
            },
            es: {
                title: "Trastorno Neurológico Funcional",
                clusters: {
                    symptoms: {
                        label: "Síntomas",
                        color: '#D32F2F', center: { x: -350, y: 150, z: -100 },
                        def: "Manifestaciones físicas comunes.",
                        words: [
                            { t: "Debilidad", d: "Debilidad repentina o parálisis, a menudo arrastrando la pierna al caminar.", w: "Paresia" },
                            { t: "Temblor", d: "Temblor involuntario, a menudo variable en ritmo o distraído por otros movimientos.", w: "Temblor" },
                            { t: "Crisis Disociativas", d: "Ataques no epilépticos (CNE) o convulsiones disociativas.", w: "Crisis_no_epilépticas_psicógenas" },
                            { t: "Marcha Funcional", d: "Patrones anormales al caminar, como arrastrar una pierna o lentitud excesiva.", w: "Trastorno_de_la_marcha" },
                            { t: "Distonía", d: "Contracciones musculares involuntarias que causan movimientos repetitivos o de torsión.", w: "Distonía" },
                            { t: "Pérdida Sensorial", d: "Entumecimiento u hormigueo que a menudo se detiene abruptamente.", w: "Parestesia" },
                            { t: "Problemas del Habla", d: "Disfonía funcional (susurros), tartamudeo o habla arrastrada.", w: "Disfonía" },
                            { t: "Niebla Mental", d: "Dificultades cognitivas que implican memoria, concentración y sentirse 'ausente'.", w: "Embotamiento_de_la_conciencia" },
                            { t: "Fatiga", d: "Cansancio extremo que no se alivia con el descanso.", w: "Fatiga_(medicina)" },
                            { t: "Alteración Visual", d: "Visión borrosa, visión de túnel o ceguera temporal.", w: "Deficiencia_visual" },
                            { t: "Ataques de Caída", d: "Caídas repentinas sin pérdida de conciencia.", w: "Trastorno_neurológico_funcional" },
                            { t: "Dolor Crónico", d: "Dolor persistente que a menudo coexiste con síntomas funcionales.", w: "Dolor_crónico" },
                            { t: "Somatización", d: "Producción de síntomas médicos recurrentes sin causa orgánica.", w: "Somatización" },
                            { t: "Tics Funcionales", d: "Movimientos motores o vocalizaciones repentinos, rápidos y no rítmicos.", w: "Tic" }
                        ]
                    },
                    mechanisms: {
                        label: "Mecanismos",
                        color: '#512DA8', center: { x: 350, y: 150, z: -100 },
                        def: "Teorías que explican por qué ocurre el TNF.",
                        words: [
                            { t: "Problema de Software", d: "Hardware intacto, fallo en el software.", w: "Trastorno_neurológico_funcional" },
                            { t: "Codificación Predictiva", d: "El cerebro predice síntomas basados en expectativas.", w: "Codificación_predictiva" },
                            { t: "Atención", d: "Enfoque anormal en el cuerpo; el movimiento mejora al distraerse.", w: "Atención" },
                            { t: "Agencia", d: "Sentido interrumpido de propiedad del movimiento.", w: "Sentido_de_agencia" },
                            { t: "Sistema Límbico", d: "Centro emocional secuestrando el control motor.", w: "Sistema_límbico" },
                            { t: "Desconexión", d: "Desconexión funcional entre áreas de planificación y ejecución.", w: "Conectividad_funcional" },
                            { t: "Sensibilización Central", d: "Sistema nervioso atascado en alta reactividad.", w: "Sensibilización_central" },
                            { t: "Biopsicosocial", d: "Combinación de factores biológicos, psicológicos y sociales.", w: "Modelo_biopsicosocial" },
                            { t: "Psicogénico", d: "Término antiguo que sugiere que los síntomas están 'todo en la mente'.", w: "Enfermedad_psicogénica" },
                            { t: "Conversión", d: "Concepto freudiano de síntomas físicos que resuelven conflictos emocionales.", w: "Trastorno_de_conversión" },
                            { t: "Desencadenante", d: "Lesión física o enfermedad que precipita el inicio.", w: "Desencadenante_(psicología)" },
                            { t: "Cerebro Bayesiano", d: "Teoría de que el cerebro genera modelos del mundo y los actualiza.", w: "Inferencia_bayesiana" },
                            { t: "Nocebo", d: "Expectativas negativas que conducen a resultados negativos.", w: "Efecto_nocebo" }
                        ]
                    },
                    diagnosis: {
                        label: "Diagnóstico",
                        color: '#1565C0', center: { x: -200, y: -250, z: 200 },
                        def: "Cómo se identifica el TNF.",
                        words: [
                            { t: "Signo de Hoover", d: "La debilidad en la extensión de la cadera mejora con resistencia contralateral.", w: "Signo_de_Hoover" },
                            { t: "Arrastre", d: "El temblor adopta el ritmo de un golpeteo externo.", w: "Trastorno_neurológico_funcional" },
                            { t: "Distractibilidad", d: "Los síntomas mejoran con la distracción.", w: "Distracción" },
                            { t: "Signos Positivos", d: "Características clínicas específicas únicas del TNF.", w: "Trastorno_neurológico_funcional" },
                            { t: "Inclusión", d: "Diagnóstico basado en signos, no solo en exclusión.", w: "Diagnóstico_diferencial" },
                            { t: "IRM Normal", d: "Los escáneres muestran una estructura intacta (hardware).", w: "Imagen_por_resonancia_magnética" },
                            { t: "Video EEG", d: "Distingue las convulsiones disociativas de la epilepsia.", w: "Electroencefalografía" },
                            { t: "Neurólogo", d: "Especialista en trastornos del sistema nervioso.", w: "Neurología" },
                            { t: "Inconsistencia", d: "Variación en la gravedad de los síntomas según el contexto.", w: "Trastorno_neurológico_funcional" },
                            { t: "Incongruencia", d: "Síntomas que no se alinean con las vías anatómicas.", w: "Trastorno_neurológico_funcional" },
                            { t: "Signo de la Mueca", d: "Muecas faciales durante el movimiento con esfuerzo.", w: "Trastorno_neurológico_funcional" },
                            { t: "Deriva sin Pronación", d: "El brazo cae sin girar hacia adentro (a diferencia del accidente cerebrovascular).", w: "Prueba_de_pronación" }
                        ]
                    },
                    treatment: {
                        label: "Tratamiento",
                        color: '#2E7D32', center: { x: 300, y: -250, z: 200 },
                        def: "Terapias para la recuperación.",
                        words: [
                            { t: "Neuroplasticidad", d: "Capacidad del cerebro para reconectarse a sí mismo.", w: "Neuroplasticidad" },
                            { t: "Fisioterapia", d: "Reentrenamiento de patrones de movimiento normales.", w: "Fisioterapia" },
                            { t: "TCC", d: "Terapia Cognitivo Conductual para el manejo de síntomas.", w: "Terapia_cognitivo-conductual" },
                            { t: "Reentrenamiento", d: "Acceder nuevamente a programas motores normales.", w: "Rehabilitación" },
                            { t: "Terapia Ocupacional", d: "Recuperar la independencia en la vida diaria.", w: "Terapia_ocupacional" },
                            { t: "Multidisciplinario", d: "Enfoque de equipo (Neuro, Fisio, Psico).", w: "Interdisciplinariedad" },
                            { t: "Pacing", d: "Gestión de la actividad para evitar ciclos de auge y caída.", w: "Gestión_del_tiempo" },
                            { t: "Educación", d: "Entender el diagnóstico es terapéutico.", w: "Psicoeducación" },
                            { t: "Distracción", d: "Evitar el monitoreo consciente para facilitar el movimiento.", w: "Distracción" },
                            { t: "Aceptación", d: "Enfocarse en la recuperación en lugar de buscar causas.", w: "Terapia_de_aceptación_y_compromiso" },
                            { t: "Ejercicio Gradual", d: "Aumentar lentamente la tolerancia a la actividad.", w: "Ejercicio_físico" },
                            { t: "Validación", d: "Reconocer que los síntomas son reales.", w: "Validación_(psicología)" },
                            { t: "Hipnoterapia", d: "Uso de estados de trance para alterar la percepción de los síntomas.", w: "Hipnoterapia" },
                            { t: "Terapia de Espejo", d: "Uso de retroalimentación visual para engañar al cerebro.", w: "Caja_espejo" }
                        ]
                    }
                }
            }
        };

        // --- Global Variables ---
        let camera, scene, renderer, controls;
        let isAnimating = true;
        let wordObjects = [];
        let baseRotationSpeed = 0.5;
        let currentLang = 'en';

        // Intro Animation Variables
        let isIntroAnimating = false;
        let introProgress = 0;
        const startPos = new THREE.Vector3(0, 2000, 5000);
        let endPos = new THREE.Vector3(0, 500, 1600); // Dynamic

        // --- Setup ---
        function init() {
            const container = document.getElementById('container');

            // 1. Camera
            camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);

            // 2. Scene
            scene = new THREE.Scene();

            // 3. Renderer
            renderer = new CSS3DRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0px';
            container.appendChild(renderer.domElement);

            // 4. Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = baseRotationSpeed;

            // 5. Load Initial Data
            loadData(currentLang);

            // 6. Events & Listeners
            window.addEventListener('resize', onWindowResize);

            document.getElementById('toggle-anim').addEventListener('click', toggleAnimation);
            document.getElementById('reset-cam').addEventListener('click', () => startIntroAnimation());

            // Modals
            document.getElementById('close-tooltip').addEventListener('click', closeTooltip);
            document.getElementById('tooltip-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'tooltip-overlay') closeTooltip();
            });

            document.getElementById('info-btn').addEventListener('click', showInfo);
            document.getElementById('close-info').addEventListener('click', closeInfo);
            document.getElementById('info-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'info-overlay') closeInfo();
            });

            // Language Switch
            document.getElementById('lang-select').addEventListener('change', (e) => {
                currentLang = e.target.value;
                loadData(currentLang);
            });

            // Logo Interaction
            const logo = document.getElementById('viz-logo');
            const card = document.getElementById('logo-card');
            let isFixed = false;

            logo.addEventListener('mouseenter', () => {
                card.classList.add('visible');
            });

            logo.addEventListener('mouseleave', () => {
                if (!isFixed) card.classList.remove('visible');
            });

            logo.addEventListener('click', (e) => {
                e.stopPropagation();
                isFixed = !isFixed;
                if (isFixed) {
                    logo.classList.add('active');
                    card.classList.add('visible');
                } else {
                    logo.classList.remove('active');
                    // Don't hide immediately if hovering, but logic suggests toggle fix
                    // If we unfix but are still hovering, it stays visible. 
                    // If we unfix and not hovering (unlikely on click?), it hides.
                    // We'll leave it visible because mouse is likely over it.
                }
            });

            // Close card on outside click if fixed
            document.addEventListener('click', (e) => {
                if (isFixed && !logo.contains(e.target) && !card.contains(e.target)) {
                    isFixed = false;
                    logo.classList.remove('active');
                    card.classList.remove('visible');
                }
            });

            animate();
        }

        function loadData(langKey) {
            // 1. Clean
            wordObjects.forEach(obj => scene.remove(obj));
            wordObjects = [];

            const dataset = fndData[langKey];
            const text = uiText[langKey];

            // Update UI Strings
            document.getElementById('info-head').textContent = text.guide;
            document.getElementById('info-list').innerHTML = text.infoList;
            document.getElementById('tooltip-link').textContent = text.wiki;

            // Update Control Buttons (using proper text depending on animation state)
            document.getElementById('reset-cam').textContent = text.reset;
            const toggleBtn = document.getElementById('toggle-anim');
            toggleBtn.textContent = isAnimating ? text.autoPilot : text.resume;

            // 2. Build Scene
            Object.keys(dataset.clusters).forEach(clusterKey => {
                const groupData = dataset.clusters[clusterKey];

                // Title
                const titleEl = document.createElement('div');
                titleEl.className = 'element title-node';
                titleEl.textContent = groupData.label || clusterKey;
                titleEl.style.color = groupData.color;
                titleEl.style.fontSize = '50px';
                addInteraction(titleEl, groupData.label || clusterKey, groupData.def, groupData.label || clusterKey);

                const titleObj = new CSS3DObject(titleEl);
                titleObj.position.set(groupData.center.x, groupData.center.y, groupData.center.z);
                scene.add(titleObj);
                wordObjects.push(titleObj);

                // Words
                const count = groupData.words.length;
                const radius = 200;
                groupData.words.forEach((wordObj, i) => {
                    const phi = Math.acos(-1 + (2 * i) / count);
                    const theta = Math.sqrt(count * Math.PI) * phi;
                    const x = radius * Math.cos(theta) * Math.sin(phi) + groupData.center.x;
                    const y = radius * Math.sin(theta) * Math.sin(phi) + groupData.center.y;
                    const z = radius * Math.cos(phi) + groupData.center.z;

                    const jitter = 30;
                    const jX = (Math.random() - 0.5) * jitter;
                    const jY = (Math.random() - 0.5) * jitter;
                    const jZ = (Math.random() - 0.5) * jitter;

                    const el = document.createElement('div');
                    el.className = 'element sub-node';
                    el.textContent = wordObj.t;
                    el.style.color = groupData.color;
                    const fontSize = Math.floor(Math.random() * (18 - 12 + 1) + 12);
                    el.style.fontSize = fontSize + 'px';

                    // Pass correct Wikipedia slug (property 'w') if it exists
                    addInteraction(el, wordObj.t, wordObj.d, wordObj.w);

                    const object = new CSS3DObject(el);
                    object.position.set(x + jX, y + jY, z + jZ);
                    scene.add(object);
                    wordObjects.push(object);
                });
            });

            startIntroAnimation();
        }

        function calculateEndPosition() {
            // Responsive Zoom Logic
            const aspect = window.innerWidth / window.innerHeight;
            let targetZ = 1600;
            let targetY = 500;

            // If Portrait (Mobile), pull back significantly
            if (aspect < 1) {
                targetZ = 2800; // Pull back
                targetY = 800;  // Lift up slightly
            } else if (aspect < 1.5) {
                // Tablets / square-ish screens
                targetZ = 2000;
            }

            return new THREE.Vector3(0, targetY, targetZ);
        }

        function startIntroAnimation() {
            endPos = calculateEndPosition();
            isIntroAnimating = true;
            introProgress = 0;
            controls.autoRotate = false;
            camera.position.copy(startPos);
            controls.target.set(0, -150, 0);
        }

        function addInteraction(domElement, title, definition, wikiSlug) {
            domElement.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                showTooltip(title, definition, wikiSlug);
                setAnimationState(false);
            });

            domElement.addEventListener('mouseenter', () => {
                if (isAnimating) controls.autoRotateSpeed = 0.1;
            });

            domElement.addEventListener('mouseleave', () => {
                if (isAnimating) controls.autoRotateSpeed = baseRotationSpeed;
            });
        }

        function showTooltip(title, definition, specificWikiSlug) {
            const overlay = document.getElementById('tooltip-overlay');
            const card = document.getElementById('tooltip-card');
            const tTitle = document.getElementById('tooltip-title');
            const tDef = document.getElementById('tooltip-def');
            const tLink = document.getElementById('tooltip-link');

            tTitle.textContent = title;
            tDef.textContent = definition;

            const wikiLang = currentLang === 'es' ? 'es' : 'en';

            // Prioritize specific slug, fallback to title-based slug
            let finalSlug = specificWikiSlug ? specificWikiSlug : title.trim().replace(/\s+/g, '_');

            tLink.href = `https://${wikiLang}.wikipedia.org/wiki/${finalSlug}`;

            overlay.style.display = 'flex';
            setTimeout(() => card.classList.add('visible'), 10);
        }

        function closeTooltip() {
            const overlay = document.getElementById('tooltip-overlay');
            const card = document.getElementById('tooltip-card');
            card.classList.remove('visible');
            setTimeout(() => {
                overlay.style.display = 'none';
                setAnimationState(true);
            }, 300);
        }

        function showInfo() {
            const overlay = document.getElementById('info-overlay');
            const card = document.getElementById('info-card');
            setAnimationState(false);
            overlay.style.display = 'flex';
            setTimeout(() => card.classList.add('visible'), 10);
        }

        function closeInfo() {
            const overlay = document.getElementById('info-overlay');
            const card = document.getElementById('info-card');
            card.classList.remove('visible');
            setTimeout(() => {
                overlay.style.display = 'none';
                setAnimationState(true);
            }, 300);
        }

        function setAnimationState(state) {
            isAnimating = state;
            controls.autoRotate = state;

            if (state) controls.autoRotateSpeed = baseRotationSpeed;

            const btn = document.getElementById('toggle-anim');
            const text = uiText[currentLang];

            if (state) {
                btn.classList.add('active');
                btn.textContent = text.autoPilot;
            } else {
                btn.classList.remove('active');
                btn.textContent = text.resume;
            }
        }

        function toggleAnimation() {
            if (isIntroAnimating) return;
            setAnimationState(!isAnimating);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isIntroAnimating) {
                introProgress += 0.008;
                if (introProgress >= 1) {
                    introProgress = 1;
                    isIntroAnimating = false;
                    if (!document.getElementById('tooltip-card').classList.contains('visible') &&
                        !document.getElementById('info-card').classList.contains('visible')) {
                        setAnimationState(true);
                    }
                }
                const t = introProgress * introProgress * (3 - 2 * introProgress);
                camera.position.lerpVectors(startPos, endPos, t);
                camera.lookAt(0, -150, 0);
            } else {
                controls.update();
            }

            const q = camera.quaternion;
            for (let i = 0; i < wordObjects.length; i++) {
                wordObjects[i].quaternion.copy(q);
            }

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>

</html>